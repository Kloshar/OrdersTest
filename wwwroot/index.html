<html>
<head>
    <meta chaset="utf-8"/>
    <style>
        table {
            font-family: 'Times New Roman'; 
            border-spacing: 0;
        }
        td {
            border: 1px solid;
            padding: 5px;
            text-align: center
        }
    </style>
</head>
<body>
    <div style="background:green "><b>Заказы</b></div>
    <p><b>Новый заказ</b></p>
    <div name="createForm">
        <div name="dnumber"><label for="Number" style="width:200px; float:left;">Номер заказа</label> <input name="Number" value="ORD-0001"></div>
        <div name="dname"><label for="Name" style="width:200px; float:left;">Имя</label> <input name="Name" value="Вася"></div>
        <p><button name="sendButton" style="height:25px" />Отправить</p>
    </div>
    <script>
        "use strict";
        
        const sendBtn = document.getElementsByName("sendButton")[0]; //кнопка отправки (используется в функциях: newLine)
        sendBtn.addEventListener('click', makeUpOrderString); //присоединяем обработчик к кнопке создания заказа

        function makeUpOrderString() {
            let orderProducts = []; //массив для хранения товаров из заказа
            const number = document.getElementsByName("Number")[0]; //получаем номер заказа
            const name = document.getElementsByName("Name")[0]; //и имя заказчика
            //далее перебор полей с выбраными товарами
            let mainDiv = document.getElementsByName("createForm")[0]; //получаем основной div
            for (let elem of mainDiv.children) { 
                if (elem.constructor.name == "HTMLDivElement" && elem.getAttribute("name") == null) {
                    let name = elem.children.selBox.selectedOptions[0].value;
                    
                    if (name != "Выберите товар"){ //отсекаем последнюю строку (пустую)                        
                        let product = { title: elem.children.selBox.selectedOptions[0].value, amount: elem.children.costInput.value, price: elem.children.amountInput.value }; //добавляем значения с объект     
                        orderProducts[orderProducts.length] = product; //добавляем в массив
                    }                    
                }                
            }//перебираем строки с товарами
            if (orderProducts.length > 0) { 
                let order = { number: number.value, name: name.value, products: orderProducts };
                //console.log(JSON.stringify(order));
                sendOrderData(JSON.stringify(order));                
            }//если есть товары
        }
        async function sendOrderData(orderString){
            const response = await fetch("/api/order", { method: "POST", headers: { "Accept": "application/json" }, body: orderString }); //отправляем на сервер запрос POST (заказ с товарами)
            if (response.ok === true) {
                alert(response.status);
                //const products = await response.json(); //получаем данные в json
                //return products;
            }
        }

        let products = getProductNames(); //наименования товаром с ценой (грёбанный промис)
        async function getProductNames() { 
            const response = await fetch("/api/productnames", { method: "GET", headers: { "Accept": "application/json" } }); //получаем промис
            if (response.ok === true) {
                const products = await response.json(); //получаем данные в json
                return products;
            }
            else { return null; }           
        } //функция для получения данных о товарах из таблицы Product
        function addOptions(sel, products) { //аргументы: select бокс и промис с названиями товаров
            products.then(
                result => {
                    for (let i = 0; result.length; i++) {
                        const opt = document.createElement('option'); //создаём строку                        
                        opt.value = result[i].title;
                        opt.text = result[i].title;
                        sel.append(opt);
                    }
                });            
        } //добавление товаров в комбобокс
        function fillData() {
            
            const sel = this;            
            products.then(
                result => {
                    for (let article of result) {
                        if (article.title == sel.value) {
                            sel.nextElementSibling.value = 1;
                            sel.nextElementSibling.nextElementSibling.value = article.price;
                        }                        
                    }
                    if (sel.parentNode.nextElementSibling.constructor.name == "HTMLParagraphElement") {
                        newLine(); //если нет следующей строки, то создаём
                    }
                });
        } //заполнение соседних с товаром ячеек
        function newLine() {            
            const div = document.createElement('div'); //создаём строку            
            const label = document.createElement('label'); //создаём заголовок
            label.textContent = "Товар";
            label.style.width = '200px';
            label.style.display = 'inline-block';
            const select = document.createElement('select'); //создаём комбобокс
            select.name = "selBox";
            select.addEventListener("change", fillData); //присоединяем обработчик изменения товара для заполнения цены
            
            const option1 = document.createElement('option'); //создаём выбор
            option1.text = "Выберите товар";
            option1.disabled = true;
            option1.selected = true;
            select.append(option1); //добавляем варианты выбора в select
            
            addOptions(select, products); //заполняем выбор товаров

            
            const cost = document.createElement('input'); //создаём поле
            cost.name = "amountInput";
            const amount = document.createElement('input'); //создаём поле
            amount.name = "costInput";

            div.append(label, select, amount, cost); //добавляем элементы строки в блок

            sendBtn.parentNode.before(div); //вставляем перед кнопкой отправки
        } //создание новой строки для выбора товара
        async function getOrders() { //GET запрос на сервер
            const response = await fetch("/api/order", { method: "GET", headers: { "Accept": "application/json" } }); //получаем ответ
            if (response.ok === true) {
                const orders = await response.json(); //ожидаем json, получаем Array
                let table = document.createElement('table'); //создаём таблицу
                if (orders.length > 0) { //если в таблице есть заказы
                    table.appendChild(makeTableHeader(orders)); //создаём шапку таблицы для вывода
                    for (let i = 0; i < makeOrderRows(orders).length; i++) { //добавляем строки с записями (заказами)
                        table.append(makeOrderRows(orders)[i]);
                    }
                    document.body.append(table);
                }
            }
        } //получаем заказы с сервера
        function makeTableHeader(ar) { 
            let row = document.createElement('tr');
            for (let key in ar[0]) { //перебираем ключи объекта первого элемента массива
                let cell = document.createElement('td');
                cell.textContent = key;
                row.appendChild(cell);
            }
            //добавляем три пустых ячейки под кнопки просмотр, редактирование, удаление
            let cell1 = document.createElement('td');
            row.appendChild(cell1);
            let cell2 = document.createElement('td');
            row.appendChild(cell2);
            let cell3 = document.createElement('td');
            row.appendChild(cell3);

            return row; //возвращаем строку с ячейками
        } //функция принимает массив объектов (заказов) и возвращает шапку таблицы с заголовками
        function makeOrderRows(ar) { 
            let rows = new Array(); //массив для строк

            for (let i = 0; i < ar.length; i++) {
                let row = document.createElement('tr'); //строка для каждой записи
                for (let key in ar[i]) {
                    let cell = document.createElement('td'); //ячейка для каждого поля аписи
                    cell.textContent = ar[i][key];
                    row.appendChild(cell);
                }
                //добавляем три кнопки
                let cell1 = document.createElement('td');
                let btnView = document.createElement('button');
                btnView.textContent = 'View';
                btnView.addEventListener("click", viewButtonhandler);
                cell1.appendChild(btnView);
                row.appendChild(cell1);

                function viewButtonhandler() {
                    let idValue = this.parentNode.parentNode.childNodes[0].childNodes[0].data;
                    alert(idValue);
                }

                let cell2 = document.createElement('td');
                let btnEdit = document.createElement('button');
                btnEdit.textContent = 'Edit';
                btnEdit.addEventListener("click", editButtonhandler);
                cell2.appendChild(btnEdit);
                row.appendChild(cell2);

                function editButtonhandler() {
                    let idValue = this.parentNode.parentNode.childNodes[0].childNodes[0].data;
                    alert(idValue);
                }

                let cell3 = document.createElement('td');
                let btnDelete = document.createElement('button');
                btnDelete.textContent = 'Delete';
                btnDelete.addEventListener("click", deleteButtonhandler);
                cell3.appendChild(btnDelete);
                row.appendChild(cell3);

                function deleteButtonhandler() {
                    let btn = this; //переменная с кнопкой
                    let idValue = btn.parentNode.parentNode.childNodes[0].childNodes[0].data; //извлекаем значение первой ячейки в строке с кнопкой
                    deleteOrder(idValue, btn); //удаление из бд и удаление строки таблицы
                }

                rows[i] = row;
            }
            return rows;
        } //функция принимает массив объектов (заказов) и возвращает строки с заказами
        async function deleteOrder(id, btn) { //DELETE запрос на сервер
            const response = await fetch(`/api/deleteOrder/${id}`, { method: "DELETE", headers: { "Accept": "application/json" } }); //получаем ответ
            //alert("Запрос отправлен на сервер. Статус: " + response.status);
            if (response.ok === true) {
                let row = btn.parentNode.parentNode; //находим строку таблицы
                row.remove(); //удаляем
            }
        } //удаление заказа       

        newLine(); //строка с выбором товара
        getOrders(); //отправляем GET запрос на сервер

    </script>
</body>
</html>