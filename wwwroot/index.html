<html>
<head>
    <meta chaset="utf-8"/>
    <style>
        table {
            font-family: 'Times New Roman'; 
            border-spacing: 0;
        }
        td {
            border: 1px solid;
            padding: 5px;
            text-align: center
        }
    </style>
</head>
<body>
    <div style="width:20px; height:20px; background:green"></div>

    <script>
        "use strict";
        async function getOrders() { //GET запрос на сервер
            const response = await fetch("/api/order", { method: "GET", headers: { "Accept": "application/json" } }); //получаем ответ
            if (response.ok === true) {
                const orders = await response.json(); //ожидаем json, получаем Array
                let table = document.createElement('table'); //создаём таблицу
                table.style.content = 'center';

                if (orders.length > 0) { //если в таблице есть заказы                    
                    table.appendChild(makeTableHeader(orders)); //создаём шапку таблицы для вывода
                    for (let i = 0; i < makeOrderRows(orders).length; i++) { //добавляем строки с записями (заказами)
                        table.append(makeOrderRows(orders)[i]);
                    }
                    document.body.append(table);
                }                
            }
        }
        function makeTableHeader(ar) { //функция принимает массив объектов (заказов) и возвращает шапку таблицы с заголовками
            let row = document.createElement('tr');
            for (let key in ar[0]) { //перебираем ключи объекта первого элемента массива
                let cell = document.createElement('td');
                cell.textContent = key;
                row.appendChild(cell);
            }
            //добавляем три пустых ячейки под кнопки просмотр, редактирование, удаление
            let cell1 = document.createElement('td');
            row.appendChild(cell1);
            let cell2 = document.createElement('td');
            row.appendChild(cell2);
            let cell3 = document.createElement('td');
            row.appendChild(cell3);

            return row; //возвращаем строку с ячейками
        }
        function makeOrderRows(ar) { //функция принимает массив объектов (заказов) и возвращает строки с заказами
            let rows = new Array(); //массив для строк

            for (let i = 0; i < ar.length; i++) {
                let row = document.createElement('tr'); //строка для каждой записи
                for (let key in ar[i]) {
                    let cell = document.createElement('td'); //ячейка для каждого поля аписи
                    cell.textContent = ar[i][key];
                    row.appendChild(cell);
                }
                //добавляем три кнопки
                let cell1 = document.createElement('td');
                let btnView = document.createElement('button');
                btnView.textContent = 'View';
                btnView.addEventListener("click", viewButtonhandler);
                cell1.appendChild(btnView);
                row.appendChild(cell1);

                function viewButtonhandler() {
                    let idValue = this.parentNode.parentNode.childNodes[0].childNodes[0].data;
                    alert(idValue);
                }

                let cell2 = document.createElement('td');
                let btnEdit = document.createElement('button');
                btnEdit.textContent = 'Edit';
                btnEdit.addEventListener("click", editButtonhandler);
                cell2.appendChild(btnEdit);
                row.appendChild(cell2);

                function editButtonhandler() {
                    let idValue = this.parentNode.parentNode.childNodes[0].childNodes[0].data;
                    alert(idValue);
                }

                let cell3 = document.createElement('td');
                let btnDelete = document.createElement('button');
                btnDelete.textContent = 'Delete';
                btnDelete.addEventListener("click", deleteButtonhandler);
                cell3.appendChild(btnDelete);
                row.appendChild(cell3);

                function deleteButtonhandler() {
                    let btn = this;
                    let idValue = btn.parentNode.parentNode.childNodes[0].childNodes[0].data;
                    //alert(idValue);
                    deleteOrder(idValue, btn);
                }

                rows[i] = row;
            }
            return rows;
        }
        async function deleteOrder(id, btn) { //DELETE запрос на сервер
            const response = await fetch(`/api/deleteOrder/${id}`, { method: "DELETE", headers: { "Accept": "application/json" } }); //получаем ответ
            //alert("Запрос отправлен на сервер. Статус: " + response.status);
            if (response.ok === true) {
                let row = btn.parentNode.parentNode; //находим строку таблицы
                row.remove(); //удаляем
            }
        }
        getOrders(); //отправляем GET запрос на сервер
    </script>
</body>
</html>